generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum PlanType {
  FREE
  PREMIUM
  LIFETIME
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum QuizType {
  MULTIPLE_CHOICE
  FILL_IN_BLANK
  LISTENING
  MATCHING
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_BLANK
  AUDIO
}

enum CourseLevel {
  BEGINNER
  ELEMENTARY
  INTERMEDIATE
  ADVANCED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum TopikLevel {
  TOPIK_I
  TOPIK_II
}

enum TopikExamStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TopikSectionType {
  LISTENING
  READING
  WRITING
}

enum TopikQuestionType {
  MCQ
  SHORT_TEXT
  ESSAY
}

enum TopikSessionStatus {
  IN_PROGRESS
  SUBMITTED
  EXPIRED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String?
  phoneNumber  String?  @unique
  googleSub    String?  @unique
  displayName  String
  avatarUrl    String?
  role         UserRole @default(USER)
  totalXP      Int      @default(0)
  streakDays   Int      @default(0)
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  subscriptions     Subscription[]
  progress          UserProgress[]
  vocabularyReviews UserVocabularyReview[]
  writingPractices  AIWritingPractice[]
  analyticsEvents   AnalyticsEvent[]
  badges            UserBadge[]
  dailyGoals        DailyGoal[]
  passwordResetCodes PasswordResetCode[]

  topikSessions TopikSession[]
}

model PasswordResetCode {
  id        String   @id @default(uuid())
  userId    String
  codeHash  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model TopikExam {
  id              String          @id @default(uuid())
  title           String
  year            Int
  topikLevel      TopikLevel
  level           String?
  durationMinutes Int
  totalQuestions  Int
  status          TopikExamStatus @default(DRAFT)
  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  sections  TopikExamSection[]
  sessions  TopikSession[]

  @@index([topikLevel])
  @@index([year])
  @@index([status])
}

model TopikExamSection {
  id              String           @id @default(uuid())
  examId          String
  type            TopikSectionType
  orderIndex      Int
  durationMinutes Int?
  maxScore        Int              @default(100)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  exam      TopikExam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  questions TopikQuestion[]

  @@unique([examId, orderIndex])
  @@index([examId])
}

model TopikQuestion {
  id            String            @id @default(uuid())
  examSectionId String
  questionType  TopikQuestionType
  orderIndex    Int
  contentHtml   String
  audioUrl      String?
  listeningScript String?
  correctTextAnswer String?
  scoreWeight   Int               @default(1)
  explanation   String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  section TopikExamSection @relation(fields: [examSectionId], references: [id], onDelete: Cascade)
  choices TopikChoice[]
  answers TopikAnswer[]

  @@unique([examSectionId, orderIndex])
  @@index([examSectionId])
}

model TopikChoice {
  id         String       @id @default(uuid())
  questionId String
  content    String
  isCorrect  Boolean      @default(false)
  orderIndex Int
  createdAt  DateTime     @default(now())

  question TopikQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers  TopikAnswer[]

  @@unique([questionId, orderIndex])
  @@index([questionId])
}

model TopikSession {
  id                   String            @id @default(uuid())
  userId               String
  examId               String
  status               TopikSessionStatus @default(IN_PROGRESS)
  startedAt            DateTime          @default(now())
  submittedAt          DateTime?
  expiresAt            DateTime?
  remainingSeconds     Int
  currentQuestionIndex Int               @default(0)
  sectionTypes          TopikSectionType[] @default([])
  totalScore           Int?
  bestScoreSnapshot    Int?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam    TopikExam @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers TopikAnswer[]

  @@index([userId])
  @@index([examId])
  @@index([status])
}

model TopikAnswer {
  id              String   @id @default(uuid())
  sessionId       String
  questionId      String
  selectedChoiceId String?
  textAnswer      String?
  isCorrect       Boolean?
  score           Int?
  flagged         Boolean  @default(false)
  aiScore         Int?
  aiFeedback      Json?
  aiReviewedAt    DateTime?
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  session TopikSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question TopikQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedChoice TopikChoice? @relation(fields: [selectedChoiceId], references: [id], onDelete: SetNull)

  @@unique([sessionId, questionId])
  @@index([sessionId])
  @@index([questionId])
}

model Subscription {
  id        String             @id @default(uuid())
  userId    String
  planType  PlanType           @default(FREE)
  startDate DateTime           @default(now())
  endDate   DateTime?
  status    SubscriptionStatus @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Course {
  id           String      @id @default(uuid())
  title        String
  description  String
  level        CourseLevel @default(BEGINNER)
  isPremium    Boolean     @default(false)
  thumbnailUrl String?
  published    Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  sections Section[]
}

model Section {
  id         String   @id @default(uuid())
  courseId   String
  title      String
  orderIndex Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]
}

model Lesson {
  id               String   @id @default(uuid())
  sectionId        String
  title            String
  description      String   @default("")
  orderIndex       Int      @default(0)
  estimatedMinutes Int      @default(10)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  section      Section        @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  vocabularies Vocabulary[]
  grammars     Grammar[]
  dialogues    Dialogue[]
  quizzes      Quiz[]
  progress     UserProgress[]
}

model Vocabulary {
  id              String     @id @default(uuid())
  lessonId        String
  korean          String
  vietnamese      String
  pronunciation   String     @default("")
  exampleSentence String     @default("")
  exampleMeaning  String     @default("")
  audioUrl        String?
  difficulty      Difficulty @default(EASY)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  lesson  Lesson                @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  reviews UserVocabularyReview[]
}

model Grammar {
  id            String   @id @default(uuid())
  lessonId      String
  pattern       String
  explanationVN String
  example       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model Dialogue {
  id            String   @id @default(uuid())
  lessonId      String
  speaker       String
  koreanText    String
  vietnameseText String
  audioUrl      String?
  orderIndex    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model Quiz {
  id        String   @id @default(uuid())
  lessonId  String
  title     String
  quizType  QuizType @default(MULTIPLE_CHOICE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson    Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
}

model Question {
  id            String       @id @default(uuid())
  quizId        String
  questionType  QuestionType @default(MULTIPLE_CHOICE)
  questionText  String
  audioUrl      String?
  correctAnswer String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options Option[]
}

model Option {
  id         String   @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean  @default(false)
  createdAt  DateTime @default(now())

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model UserProgress {
  id          String    @id @default(uuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  score       Int       @default(0)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model UserVocabularyReview {
  id            String   @id @default(uuid())
  userId        String
  vocabularyId  String
  reviewLevel   Int      @default(0)
  nextReviewAt  DateTime @default(now())
  correctStreak Int      @default(0)
  wrongCount    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabulary Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  @@unique([userId, vocabularyId])
}

model AIWritingPractice {
  id         String   @id @default(uuid())
  userId     String
  prompt     String
  userAnswer String
  aiFeedback String?
  score      Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  userId    String
  eventType String
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Badge {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  iconUrl     String   @default("")
  requiredXP  Int      @default(0)
  createdAt   DateTime @default(now())

  userBadges UserBadge[]
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

model DailyGoal {
  id        String   @id @default(uuid())
  userId    String
  targetXP  Int      @default(50)
  currentXP Int      @default(0)
  date      DateTime @default(now()) @db.Date
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}
